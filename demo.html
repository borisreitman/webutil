<body onload="demo()">
<div id="$foo">
  Go to https://example.com 
</div>
<style>
a { display: block }
button { display: block }
</style>
<a id="$download">download test</a>
<script>
    var _test_blob;

    async function demo(){
      var { Rand_Util } = WebUtil;
      console.log( Rand_Util.random_hex_string() );

      const { URL_Util } = WebUtil;
      let query = "a=b&c=d";
      console.log(URL_Util.decode_url_options(query));

      const { linkify, linkify_text } = WebUtil.HTML_Util;
      linkify($foo);
      document.body.appendChild( linkify_text("Go to https://bing.com") )

      const { Date_Util } = WebUtil;
      var date = new Date();
      date.setDate(date.getDate() - 1)
      console.log( Date_Util.time_ago( date, new Date() ) )             // 1 day ago
      console.log( Date_Util.short_date( date, new Date() ) )           // Apr 8
      console.log( Date_Util.time_remaining_until( new Date(), date ) ) // 1 day
      console.log( Date_Util.date_str_to_epoch( "2021/04/11" ) )        // 1618124400
      console.log( Date_Util.date_to_epoch( date ) )                    // 1617934205

      const { Net_Util } = WebUtil;
      var url = "https://code.jquery.com/jquery-3.6.0.slim.min.js";
      var bytes = await Net_Util.fetch_as_byte_array( url, {
        integrity: 'sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=' 
      });
      console.log(`Downloaded ${bytes.length} bytes`);


      const { hmac_sign, hmac_verify, get_hmac_key } = WebUtil.Crypt_Util;
      var raw = Rand_Util.random_bytes(32);
      var key = await get_hmac_key(raw);
      console.log(await WebUtil.Crypt_Util.get_jwk(key));
      var sig = await hmac_sign(key, "hello world")
      if (hmac_verify(key, sig, "hello world")){
        console.log("verified");
      }

      const { base64_url_encode_byte_array, base64_encode_byte_array } = WebUtil.Data_Util;
      const { generate_dh_keypair, derive_dh_shared_secret, get_dh_key, get_jwk } = WebUtil.Crypt_Util;
      // Alice does
      var alice_keypair = await generate_dh_keypair();
      var alice_pubkey_jwk = await get_jwk(alice_keypair.publicKey);

      // Send Alice's pub key to Bob
      // Bob does
      var bob_keypair = await generate_dh_keypair();
      var bob_pubkey_jwk = await get_jwk(bob_keypair.publicKey);

      var alice_pubkey = await get_dh_key(alice_pubkey_jwk);
      var shared_secret_raw = await derive_dh_shared_secret(bob_keypair.privateKey, alice_pubkey)
      var shared_secret = base64_url_encode_byte_array(shared_secret_raw);

      // Send Bob's pub key to Alice
      // Alice does
      var bob_pubkey = await get_dh_key(bob_pubkey_jwk);
      var shared_secret_raw2 = await derive_dh_shared_secret(alice_keypair.privateKey, bob_pubkey)
      var shared_secret2 = base64_url_encode_byte_array(shared_secret_raw2);

      // both should be equal
      console.log(shared_secret);
      console.log(shared_secret2);

      // Compression of DH public key
      const { base64_url_decode_to_byte_array } = WebUtil.Data_Util;


      var x = alice_pubkey_jwk.x;
      var y = alice_pubkey_jwk.y;
      console.log("original x: ", x);
      console.log("original y: ", y);

      x = base64_url_decode_to_byte_array(x);
      y = base64_url_decode_to_byte_array(y);

      const { compress_ecc_coord, decompress_ecc_p256_coord } = WebUtil.Crypt_Util;
      var compressed = compress_ecc_coord(x,y);
      console.log(compressed);

      var [x,y] = decompress_ecc_p256_coord(compressed);
      x = base64_url_encode_byte_array(x);
      y = base64_url_encode_byte_array(y);
      console.log("decompressed x:", x);
      console.log("decompressed y:", y);


      // AES-256 GCM

      const { symmetric_encrypt, symmetric_decrypt, generate_symmetric_key,
              get_symmetric_key_from_byte_array,
              get_symmetric_key_from_string } = WebUtil.Crypt_Util;
      const { base64_decode_to_byte_array } = WebUtil.Data_Util;

      // the Base64-URL encoded ECDH established shared_secret from above should work as an AES key
      var key = await get_symmetric_key_from_string(shared_secret);
      //OR: var key = await generate_symmetric_key();
      //OR: var key = await get_symmetric_key_from_byte_array( Rand_Util.random_bytes(32) );

      var nonce = await Rand_Util.random_bytes(12);
      var ciphertext = await symmetric_encrypt(key, nonce, "hello world")

      // send nonce and ciphertext over the network

      var plaintext = await symmetric_decrypt(key, nonce, ciphertext);
      if (plaintext == "hello world"){
        console.log("valid");
      }

      // Key-encryption-Key (KEK)

      const { wrap_symmetric_key, unwrap_symmetric_key } = WebUtil.Crypt_Util;

      var kek = await generate_symmetric_key();
      var wrapping_nonce = await Rand_Util.random_bytes(12);
      var key_ciphertext = await wrap_symmetric_key(kek, wrapping_nonce, key);
      console.log(key_ciphertext.length); // 48 bytes
      
      // Store key_ciphertext and wrapping_nonce in a public location. 
      // They are byte arrays, so you may want to base64 encode them.

      var key2 = await unwrap_symmetric_key(kek, wrapping_nonce, key_ciphertext);

      var plaintext = await symmetric_decrypt(key2, nonce, ciphertext);
      if (plaintext == "hello world"){
        console.log("valid");
      }

      // pack and unpack binary data
      const { 
        encode_byte_arrays_in_dict, 
        decode_byte_arrays_in_dict } = WebUtil.Data_Util;
        
      var package = encode_byte_arrays_in_dict({ 'foo': 'bar', nonce, key_ciphertext });
      console.log(package);
      
      package = decode_byte_arrays_in_dict(package);
      console.log(package);

      // Html Util -- download
      const { prepare_download_link, 
        create_blob_from_dict, 
        create_blob_from_byte_array } = WebUtil.HTML_Util;

      var data = {'a':1,'b':2};
      var blob = create_blob_from_dict(data);
      prepare_download_link(blob, 'foo.txt', $download)

      // big numbers
      // NIST P-256 (secp256r1) 2^256 - 2^224 + 2^192 + 2^96 - 1
      const prime = 2n**256n - 2n**224n + 2n**192n + 2n**96n - 1n;
      console.log("prime: ", prime);

      const { bigint_to_byte_array, byte_array_to_bigint,
        byte_array_to_hex, hex_to_byte_array } = WebUtil.Data_Util;
      console.log(bigint_to_byte_array('123456789012345678901234567890'));
      console.log(bigint_to_byte_array(prime));
      console.log("prime: ", byte_array_to_bigint(bigint_to_byte_array(prime)));
      console.log(byte_array_to_hex(bigint_to_byte_array(prime)));
      console.log(hex_to_byte_array(byte_array_to_hex(bigint_to_byte_array(prime))));

      const { base58_encode_byte_array, base58_decode_to_byte_array } = WebUtil.Data_Util;
      var data = Rand_Util.random_bytes(32);
      console.log("original data: ", data);
      var btc_encoded = base58_encode_byte_array(data);
      console.log("bitcoin encoded data: ", btc_encoded);
      console.log("decoded from base58: ", base58_decode_to_byte_array(btc_encoded));
    }
  </script>
  <script src="./rand_util.js"></script>
  <script src="./url_util.js"></script>
  <script src="./html_util.js"></script>
  <script src="./date_util.js"></script>
  <script src="./data_util.js"></script>
  <script src="./net_util.js"></script>
  <script src="./crypt_util.js"></script>
  <script src="./data_util.js"></script>
</body>
